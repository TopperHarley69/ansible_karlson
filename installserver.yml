---
- name: Create Proxmox VM from ISO
  hosts: localhost
  gather_facts: false

  vars:
    api_host: "https://pve.karlson.dk:8006/api2/json"
    api_user: "root@pam"
    api_token_id: "pdm-admin-pdm"
    api_token: "ansible"
    node: "pve"

    vm_id: 120
    vm_name: "iso-vm-test"
    iso_storage: "local"
    iso_file: "iso/ubuntu-22.04-live-server-amd64.iso"

  tasks:

    - name: Create empty VM
      community.general.proxmox:
        api_host: "{{ api_host }}"
        api_user: "{{ api_user }}"
        api_token: "{{ api_token }}"
        node: "{{ node }}"
        vmid: "{{ vm_id }}"
        name: "{{ vm_name }}"
        memory: 4096
        cores: 2
        sockets: 1
        ostype: "ubuntu"
        scsihw: "virtio-scsi-pci"
        net:
          net0: "virtio,bridge=vmbr0"
        ide:
          ide2: "{{ iso_storage }}:{{ iso_file }},media=cdrom"
        sata:
          sata0: "local-lvm:32"
        boot: "order=ide2;scsi0"
        state: present

    - name: Start VM to begin ISO installation
      community.general.proxmox_kvm:
        api_host: "{{ api_host }}"
        api_user: "{{ api_user }}"
        api_token: "{{ api_token }}"
        node: "{{ node }}"
        vmid: "{{ vm_id }}"
        state: started
